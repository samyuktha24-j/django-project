<!DOCTYPE html>
<html>
<head>
    <title>Digital Certificate Module</title>

    <style>
        body { font-family: Arial; background: #f4f6f9; padding: 40px; }
        .box { background: white; padding: 30px; width: 750px; margin: auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, button, textarea { width: 100%; padding: 10px; margin-top: 15px; }
        button { background: #2c5364; color: white; border: none; cursor: pointer; }
        textarea { height: 120px; font-size: 12px; }
        .result { margin-top: 20px; background: #f0f0f0; padding: 15px; border-radius: 6px; }

        .cert-window { background: #fff; border: 1px solid #ccc; margin-top: 20px; }
        .cert-title { background: #202124; color: white; padding: 10px; font-weight: bold; }
        .cert-tabs { display: flex; border-bottom: 1px solid #ddd; }
        .cert-tab { padding: 8px 14px; cursor: pointer; font-weight: bold; }
        .cert-tab.active { background: #e8f0fe; border-bottom: 2px solid #1a73e8; }
        .cert-body { padding: 15px; }
        .cert-row { display: flex; margin-bottom: 6px; }
        .cert-label { width: 200px; color: #555; }
        .cert-value { flex: 1; word-break: break-all; }
        .cert-tree details { margin-bottom: 6px; }
        .tree-child { margin-left: 15px; }
        .cert-btn { background: #1a73e8; color: white; border: none; padding: 6px 10px; margin-top: 10px; }
    </style>
</head>

<body>

<div class="box">

    <!-- OEM ROOT -->
    <h2>OEM Root CA</h2>

    <!-- Generate Keys -->
    <form method="POST" action="{% url 'generate_oem_key' %}">
        {% csrf_token %}
        <button type="submit">Generate OEM Keys</button>
    </form>

    {% if private_key and public_key %}
    <div class="result">
        <textarea readonly>{{ private_key }}</textarea>
        <textarea readonly>{{ public_key }}</textarea>

        <!-- âœ… DOWNLOAD BUTTON ADDED -->
        <a href="{% url 'download_certificate' %}">
            <button type="button">Download Certificate</button>
        </a>
    </div>
    {% endif %}

    <!-- ===== CERT VIEWER (SAFE DISPLAY ONLY) ===== -->
    {% if subject %}
    <div class="cert-window">

        <div class="cert-title">
            Certificate Viewer: {{ subject }}
        </div>

        <div class="cert-tabs">
            <div class="cert-tab active" onclick="showCertTab('general')">General</div>
            <div class="cert-tab" onclick="showCertTab('details')">Details</div>
        </div>

        <div class="cert-body">

            <div id="general">
                <div class="cert-row"><div class="cert-label">Common Name</div><div class="cert-value">{{ subject }}</div></div>
                <div class="cert-row"><div class="cert-label">Issued By</div><div class="cert-value">{{ issuer }}</div></div>
                <div class="cert-row"><div class="cert-label">Issued On</div><div class="cert-value">{{ valid_from }}</div></div>
                <div class="cert-row"><div class="cert-label">Expires On</div><div class="cert-value">{{ valid_to }}</div></div>
                <div class="cert-row"><div class="cert-label">Serial</div><div class="cert-value">{{ serial }}</div></div>
                <div class="cert-row"><div class="cert-label">Fingerprint</div><div class="cert-value">{{ fingerprint }}</div></div>
            </div>

            <div id="details" style="display:none">
                <div class="cert-tree">
                    <details open>
                        <summary>Certificate Hierarchy</summary>
                        <div class="tree-child">
                            {{ issuer }}
                            <div class="tree-child">{{ subject }}</div>
                        </div>
                    </details>
                </div>
            </div>

        </div>
    </div>
    {% endif %}

</div>

<script>
function showCertTab(tab) {
    document.getElementById("general").style.display = "none";
    document.getElementById("details").style.display = "none";
    document.querySelectorAll(".cert-tab").forEach(t => t.classList.remove("active"));
    document.getElementById(tab).style.display = "block";
    event.target.classList.add("active");
}
</script>

</body>
</html>